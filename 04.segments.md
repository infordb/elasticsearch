
## Segments


![image](https://user-images.githubusercontent.com/10610884/131244745-4619e457-3194-4f58-85a1-729a74074cfb.png)


### 개념

![image](https://user-images.githubusercontent.com/10610884/131244769-45d37a73-0b5b-4c1f-87c1-9d6fd33c4102.png)

1. refresh   
segment 가 os cache에 생성되어 읽기가 가능한 상태임   
default 1초마다 refresh 발생(in-memory buffer에 input data를 모아서 refresh 수행)

```
POST /movie/_refresh
```

2. flush
os fsync() 함수 호출되어 Disk에 완전히 기록됨   
Disk에 완전히 기록 되었기 때문에 새로운 translog 시작함(translog는 ES에만 존재하는 개념임)    
default 5초마다 수행

```
POST /movie/_flush
```

3. merge   
검색 성능을 높이기 위해 segment를 병합하여 segment수를 줄인다. 

```
POST /movie/_forcemerge?max_num_segments=1
```

### Translog
#### 동작 순서




### 세그먼트 불변성
루씬에서 수정을 허용하지 앟는 세그먼트의 이러한 동작 방식을 불변성이라고 한다.    
대용량의 텍스트를 다뤄야 하는 역색인 구조에서 불변성이 제공하는 장정이 있다. 
- 동시성 문제 회피 (Lock 필요 없음)   
- 시스템 캐쉬를 적극 활용(파일 변경이 없으니..)   
- 높은 캐시 적중률 유지 (시스템 캐쉬에 오래 유지)   
- 리소스 절감 (역색인 작업이 CPU / Memory 많이 사용)

#### 데이터 삭제
1. 루씬은 삭제될 데이터가 포한된 세그먼트의 삭제 여부 비트 배열확인
2. 삭제 여부 비트 배열의 flag를 삭제로 표시
3. 기존 세그먼트에 직접적인 변경이 없으므로, 불변성 유지/ 캐쉬유지
4. 검색 작업 시 삭제 여부 비트 배열을 항상 먼저 확인하고 검색 결과에서 제외

#### 데이터 수정
1. 삭제 처리
2. 수정된 데이터를 새로운 세그먼트로 생성


